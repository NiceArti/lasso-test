function g(e){if(!e)return[];const t=e.match(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi)??[];return Array.from(new Set(t.map(n=>n.toLowerCase().trim())))}function w(e){return typeof e=="string"?e:e instanceof Request?e.url:e instanceof URL?e.toString():null}function p(e){return e.toLowerCase()==="https://chatgpt.com/backend-api/f/conversation"}function S(e){return e[1]?.body?e[1].body:e[0]instanceof Request?e[0].body:null}function y(e){return e.filter(t=>t.author.role==="user").flatMap(t=>t.content.parts??[]).filter(t=>typeof t=="string").join(" ").replace(/\s+/g," ").trim()}function E(){return new Promise(e=>{const t=n=>{if(n.data?.source!=="LASSO_EXT"||n.data?.type!=="DISMISSED_EMAILS")return;window.removeEventListener("message",t);const s=n.data.payload,i=Array.isArray(s)?s.map(d=>d.toLowerCase().trim()):[];e(i)};window.addEventListener("message",t),window.postMessage({source:"LASSO_PAGE",type:"NEED_DISMISSED_EMAILS"},"*")})}console.log("ðŸ”¥ LASSO page script loaded");let r=null,o=null,l=null;const u=window.fetch;window.fetch=async function(...e){const t=w(e[0]);if(!p(t??""))return u.apply(this,e);const n=S(e)??"",s=JSON.parse(n),i=y(s.messages),d=g(i),a=await E(),m=new Set(a.map(c=>c.toLowerCase().trim())),f=d.filter(c=>!m.has(c.toLowerCase().trim()));return f.length===0?u.apply(this,e):(window.dispatchEvent(new CustomEvent("lasso:open",{detail:{text:i,emails:f}})),new Promise(c=>{r=c,o=e,l=s}))};window.addEventListener("lasso:cancel",()=>{!r||!o||(console.log("â†©ï¸ Cancel â†’ sending original request"),u(...o).then(r),r=null,o=null,l=null)});window.addEventListener("lasso:submit",e=>{if(!r||!o||!l)return;const{modifiedText:t}=e.detail;console.log("âœ… Submit â†’ sending user-modified request");const n={...l,messages:l.messages.map(a=>a.author.role==="user"?{...a,content:{...a.content,parts:[t]}}:a)},s=JSON.stringify(n),[i,d]=o;u(i,{...d,body:s}).then(r),r=null,o=null,l=null});
